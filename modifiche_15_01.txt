Modifiche 15/01:

-- Modificata la seguente:
/* Permette di dismettere, ovvero chiudere un negozio. In particolare, oltre a dismettere tutte le tessere dei clienti associati ad esso,
è concesso specificare il codice_negozio di un secondo negozio presso il quale trasferire i prodotti ancora in vendita prima che vengano rimossi.
Se il codice_negozio è NULL, allora i prodotti in vendita vengono semplicemente rimossi. */
CREATE OR REPLACE PROCEDURE dismetti_negozio(
    _codice_negozio UUID,
    _nuovo_codice_negozio UUID DEFAULT NULL
) AS $$
DECLARE
    r RECORD;
BEGIN
    -- Revoco la validità delle tessere fedeltà relative ai clienti di tale negozio.
    UPDATE tessera_fedelta
    SET dismessa = TRUE
    WHERE codice_negozio = _codice_negozio;
    -- Imposto l'attributo dismesso del negozio in via di chiusura a true.
    UPDATE negozio
    SET dismesso = TRUE
    WHERE codice_negozio = _codice_negozio;
    IF _nuovo_codice_negozio IS NOT NULL THEN
        -- Se viene specificato alla procedura un secondo negozio presso il quale trasferire le scorte.
        LOOP
            -- Per ogni prodotto in vendita presso il negozio dismesso.
            BEGIN
                --  Se il prodotto fosse già presente allora ne viene incrementata la quantità.
                UPDATE vende
                SET quantita = quantita + r.quantita
                WHERE codice_negozio = _nuovo_codice_negozio AND codice_prodotto = r.codice_prodotto;
                -- Altrimenti crea una nuova tupla di prodotto inedito in vendita.
                IF NOT FOUND THEN
                    INSERT INTO vende(codice_negozio, codice_prodotto, prezzo, quantita)
                    VALUES (_nuovo_codice_negozio, r.codice_prodotto, r.prezzo, r.quantita);
                END IF;
            END;
            LOOP;
    END IF;
    -- Elimina ogni tupla di prodotto in vendita presso il negozio dismesso.
    DELETE FROM vende
    WHERE codice_negozio = _codice_negozio;
END;
$$ LANGUAGE plpgsql;

